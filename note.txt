cd flink-jobs/java
mvn clean package

-- lenh bash minio client --

docker exec -it mc sh
mc alias set local http://minio:9000 "$MINIO_ROOT_USER" "$MINIO_ROOT_PASSWORD"
mc alias list
mc admin info local
mc tree local
mc du local

-- kiem tra lakehouse voi trino --

trino
SHOW SCHEMAS FROM lakehouse;
SHOW TABLES FROM lakehouse.rva;



# vào container broker
docker compose exec pulsar-broker bash

# 1) Tạo tenant 'retail' và gán allowed-clusters
bin/pulsar-admin clusters list            # thường ra 'standalone'
bin/pulsar-admin tenants create retail --allowed-clusters standalone || true
bin/pulsar-admin tenants list

# 2) Tạo namespace 'retail/metadata' và gán cluster
bin/pulsar-admin namespaces create retail/metadata || true
bin/pulsar-admin namespaces set-clusters -c standalone retail/metadata



-- chuyen .ipynb sang .html --

jupyter nbconvert --to html ....ipynb


-- chay bronze ingest job (Pulsar -> Iceberg) --

# ✅ GIẢI PHÁP: Dùng Java job thay vì SQL (Table API + executeSql)
# SQL connector có issue với non-partitioned topic, Java job ổn định hơn

## CÁCH 1: Chạy Bronze Job bằng JAVA (KHUYẾN NGHỊ)

# 1. Build JAR từ source
cd flink-jobs/java
mvn clean package -DskipTests

# 2. Copy JAR vào jobmanager
docker cp target/silver-job-0.1.0.jar flink-jobmanager:/opt/flink/usrlib/bronze-job.jar

# 3. Submit job detached mode
docker exec flink-jobmanager sh -c "./bin/flink run -d -c org.rva.BronzeIngestJob /opt/flink/usrlib/bronze-job.jar"

# 4. Kiểm tra job đang chạy
docker exec flink-jobmanager sh -c "./bin/flink list"

# 5. Test gửi messages vào Pulsar (từ trong container)
docker exec pulsar-broker sh -c "python3 -c \"
import pulsar, json, time
client = pulsar.Client('pulsar://localhost:6650')
producer = client.create_producer('persistent://retail/metadata/events')
msg = {'source': {'store_id': 'S001', 'camera_id': 'CAM01', 'stream_id': 'stream1'}, 'detections': [{'det_id': 'd1', 'class': 'person', 'bbox': {'x1': 100, 'y1': 200}}], 'image_size': {'width': 1280, 'height': 720}}
for i in range(5):
    producer.send(json.dumps(msg).encode('utf-8'))
    print(f'Sent message {i+1}')
    time.sleep(0.5)
producer.close()
client.close()
print('Done')
\""

# 6. Chờ checkpoint (60s) rồi query dữ liệu
sleep 65
docker exec trino sh -c "trino --catalog lakehouse --schema rva --execute 'SELECT store_id, camera_id, COUNT(*) as cnt FROM bronze_raw GROUP BY store_id, camera_id'"

# 7. Xem Flink Web UI
# http://localhost:8081

## CÁCH 2: Chạy Bronze SQL (Legacy - có issue)

# Kiểm tra Pulsar topic có messages
docker exec pulsar-broker bin/pulsar-admin topics stats persistent://retail/metadata/events

# Kiểm tra subscriptions và consumers
docker exec pulsar-broker bin/pulsar-admin topics stats persistent://retail/metadata/events | grep -A 20 "subscriptions"

# Chạy Bronze ingest SQL (streaming job)
docker exec flink-jobmanager bash -c "cat /opt/flink/usrlib/sql/bronze_ingest.sql | /opt/flink/bin/sql-client.sh embedded"

# Kiểm tra job status
curl -s http://localhost:8081/jobs | python -m json.tool

# Xem chi tiết job metrics (thay JOB_ID)
curl -s "http://localhost:8081/jobs/{JOB_ID}/vertices/{VERTEX_ID}/subtasks/metrics?get=numRecordsIn,numRecordsOut"

# Query dữ liệu từ Trino
docker exec trino trino --execute "SELECT COUNT(*) FROM lakehouse.rva.bronze_raw"
docker exec trino trino --execute "SELECT * FROM lakehouse.rva.bronze_raw LIMIT 10"


-- build va chay java jobs (Silver/Gold) --

cd flink-jobs/java
mvn -q -DskipTests package
docker cp target/silver-job-0.1.0.jar flink-jobmanager:/opt/flink/usrlib/silver-job.jar
docker exec -it flink-jobmanager bash -lc "/opt/flink/bin/flink run -d -c org.rva.silver.SilverJob /opt/flink/usrlib/silver-job.jar"
docker exec -it flink-jobmanager bash -lc "/opt/flink/bin/flink run -d -c org.rva.gold.GoldBatchJob /opt/flink/usrlib/silver-job.jar"



docker exec minio mc alias set local http://localhost:9000 minioadmin minioadmin123
docker exec minio mc ls -r local/warehouse/rva/bronze_raw/data
docker exec minio mc ls -r local/warehouse/rva/bronze_raw/metadata

```bash
# Kích hoạt venv (nếu chưa kích hoạt)
source venv/Scripts/activate

# Chạy script replay
python scripts/replay_jsonl_to_pulsar.py

```

export MSYS_NO_PATHCONV=1
docker run --rm --network retail-video-analytics_retail-net \
  -v "$(pwd):/app" -w /app \
  -e PULSAR_SERVICE_URL=pulsar://pulsar-broker:6650 \
  python:3.10-slim bash -c "pip install -q pulsar-client && python scripts/replay_jsonl_to_pulsar.py"

docker exec flink-jobmanager bash -lc "./bin/sql-client.sh -f /opt/flink/usrlib/sql/bronze_ingest.sql"